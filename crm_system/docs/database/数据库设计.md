# 数据库设计文档

## 1. 数据库架构概述

### 1.1 技术选型

| 数据库类型 | 技术方案 | 用途 |
|-----------|---------|------|
| 主数据库 | PostgreSQL 14+ | 业务数据存储 |
| 缓存层 | Redis 7+ | 会话、热数据缓存 |
| 搜索引擎 | ElasticSearch 8+ | 全文搜索、日志分析 |
| 分析数据库 | ClickHouse | 大数据分析、报表 |
| 消息队列 | RabbitMQ / Kafka | 异步任务、事件驱动 |

### 1.2 数据库分层

```
┌─────────────────────────────────────┐
│  应用层 (Application Layer)         │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│  缓存层 (Redis)                     │
│  - 会话数据                          │
│  - 热点数据                          │
│  - 计数器                            │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│  业务数据库 (PostgreSQL)             │
│  - 客户数据                          │
│  - 员工数据                          │
│  - 业务数据                          │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│  搜索引擎 (ElasticSearch)            │
│  - 全文搜索                          │
│  - 日志分析                          │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│  分析数据库 (ClickHouse)             │
│  - 数据仓库                          │
│  - BI报表                            │
└─────────────────────────────────────┘
```

## 2. 核心数据表设计

### 2.1 客户相关表

#### customers (客户主表)

```sql
CREATE TABLE customers (
    -- 主键
    id BIGSERIAL PRIMARY KEY,
    customer_code VARCHAR(50) UNIQUE NOT NULL, -- 客户编号 CUST_xxxxx
    
    -- 基本信息
    name VARCHAR(100) NOT NULL,
    avatar_url VARCHAR(500),
    gender VARCHAR(10), -- 男/女/未知
    age INTEGER,
    birth_date DATE,
    
    -- 联系方式
    wechat_id VARCHAR(100),
    whatsapp VARCHAR(50),
    telegram VARCHAR(100),
    email VARCHAR(200),
    phone VARCHAR(50),
    
    -- 地理信息
    country VARCHAR(100),
    city VARCHAR(100),
    timezone VARCHAR(50),
    language JSONB, -- ["英语", "中文"]
    
    -- 职业信息
    occupation VARCHAR(200),
    industry VARCHAR(100),
    income_range VARCHAR(50),
    
    -- 投资信息
    investment_experience VARCHAR(50), -- 新手/中级/高级
    risk_preference VARCHAR(50), -- 保守/稳健/激进
    capital_range VARCHAR(50),
    trading_platform VARCHAR(100),
    interests JSONB, -- ["美股", "加密货币"]
    
    -- 性格特质
    personality_traits JSONB,
    communication_style TEXT,
    decision_style VARCHAR(100),
    
    -- 客户分层
    tier VARCHAR(10) NOT NULL DEFAULT 'C', -- S/A/B/C
    persona_type VARCHAR(50), -- 愿意成长/愿意负责/拥抱未来
    
    -- 评分
    intention_score INTEGER DEFAULT 0, -- 意向分数 0-60
    engagement_score INTEGER DEFAULT 0, -- 粘度指数 0-100
    ltv_prediction DECIMAL(12,2), -- 预测生命周期价值
    
    -- 客户旅程
    current_stage VARCHAR(50) NOT NULL DEFAULT 'Awareness',
    -- Awareness/Attention/Trust/Engage/Action/Subscribe/Growth/Loyal/Advocate
    
    -- 来源信息
    source_channel VARCHAR(100), -- TikTok/Facebook/推荐等
    referrer_id BIGINT REFERENCES customers(id),
    
    -- 负责人
    assigned_employee_id BIGINT REFERENCES employees(id),
    assigned_at TIMESTAMP,
    
    -- 状态
    status VARCHAR(20) NOT NULL DEFAULT 'active', -- active/inactive/blacklist
    blacklist_reason TEXT,
    
    -- 风险标记
    risk_flags JSONB, -- ["出金风险", "情绪不稳"]
    
    -- 时间戳
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    last_contact_at TIMESTAMP,
    
    -- 索引
    INDEX idx_customer_code (customer_code),
    INDEX idx_assigned_employee (assigned_employee_id),
    INDEX idx_tier (tier),
    INDEX idx_current_stage (current_stage),
    INDEX idx_intention_score (intention_score),
    INDEX idx_created_at (created_at)
);
```

#### customer_tags (客户标签表)

```sql
CREATE TABLE customer_tags (
    id BIGSERIAL PRIMARY KEY,
    customer_id BIGINT NOT NULL REFERENCES customers(id) ON DELETE CASCADE,
    tag_id BIGINT NOT NULL REFERENCES tags(id),
    
    tagged_by BIGINT REFERENCES employees(id),
    tagged_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- 自动/手动标记
    is_auto BOOLEAN DEFAULT FALSE,
    
    UNIQUE(customer_id, tag_id),
    INDEX idx_customer_id (customer_id),
    INDEX idx_tag_id (tag_id)
);
```

#### tags (标签字典表)

```sql
CREATE TABLE tags (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(50) NOT NULL UNIQUE,
    category VARCHAR(50) NOT NULL, -- 客户分层/意向/行为/风险/来源等
    color VARCHAR(20), -- 标签颜色
    icon VARCHAR(50), -- 图标
    description TEXT,
    
    is_system BOOLEAN DEFAULT FALSE, -- 系统标签不可删除
    display_order INTEGER DEFAULT 0,
    
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_category (category)
);
```

#### customer_journey (客户旅程记录表)

```sql
CREATE TABLE customer_journey (
    id BIGSERIAL PRIMARY KEY,
    customer_id BIGINT NOT NULL REFERENCES customers(id) ON DELETE CASCADE,
    
    from_stage VARCHAR(50) NOT NULL,
    to_stage VARCHAR(50) NOT NULL,
    
    duration_days INTEGER, -- 在上一阶段停留天数
    
    trigger_event VARCHAR(100), -- 触发事件
    notes TEXT,
    
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_customer_id (customer_id),
    INDEX idx_to_stage (to_stage),
    INDEX idx_created_at (created_at)
);
```

### 2.2 业务数据表

#### funnel_tofu (ToFu层数据)

```sql
CREATE TABLE funnel_tofu (
    id BIGSERIAL PRIMARY KEY,
    
    customer_id BIGINT NOT NULL REFERENCES customers(id),
    employee_id BIGINT NOT NULL REFERENCES employees(id),
    
    -- 接粉信息
    contact_date DATE NOT NULL,
    source_channel VARCHAR(100) NOT NULL,
    source_detail VARCHAR(200), -- 具体来源（某个视频/某篇文章）
    
    -- 建群信息
    joined_group BOOLEAN DEFAULT FALSE,
    group_name VARCHAR(100),
    joined_at TIMESTAMP,
    
    -- 留群信息
    stayed_in_group BOOLEAN DEFAULT FALSE,
    left_group_at TIMESTAMP,
    leave_reason VARCHAR(200),
    
    -- 初筛结果
    screening_result VARCHAR(50), -- 通过/筛掉
    screening_reason TEXT,
    
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_customer_id (customer_id),
    INDEX idx_employee_id (employee_id),
    INDEX idx_contact_date (contact_date),
    INDEX idx_source_channel (source_channel)
);
```

#### funnel_mofu (MoFu层数据)

```sql
CREATE TABLE funnel_mofu (
    id BIGSERIAL PRIMARY KEY,
    
    customer_id BIGINT NOT NULL REFERENCES customers(id),
    employee_id BIGINT NOT NULL REFERENCES employees(id),
    
    -- 互动数据
    total_conversations INTEGER DEFAULT 0,
    high_quality_conversations INTEGER DEFAULT 0,
    total_反问_count INTEGER DEFAULT 0,
    
    -- 跟票数据
    followed_recommendations BOOLEAN DEFAULT FALSE,
    follow_count INTEGER DEFAULT 0,
    
    -- 开户数据
    account_opened BOOLEAN DEFAULT FALSE,
    account_platform VARCHAR(100),
    opened_at TIMESTAMP,
    days_to_open INTEGER, -- 从接触到开户的天数
    
    -- 评分
    intention_score INTEGER DEFAULT 0,
    engagement_score INTEGER DEFAULT 0,
    
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_customer_id (customer_id),
    INDEX idx_employee_id (employee_id),
    INDEX idx_account_opened (account_opened)
);
```

#### funnel_bofu (BoFu层数据)

```sql
CREATE TABLE funnel_bofu (
    id BIGSERIAL PRIMARY KEY,
    
    customer_id BIGINT NOT NULL REFERENCES customers(id),
    employee_id BIGINT NOT NULL REFERENCES employees(id),
    
    -- 入金统计
    total_deposits DECIMAL(15,2) DEFAULT 0,
    total_withdrawals DECIMAL(15,2) DEFAULT 0,
    net_deposit DECIMAL(15,2) DEFAULT 0,
    
    deposit_count INTEGER DEFAULT 0,
    withdrawal_count INTEGER DEFAULT 0,
    
    -- 首金信息
    first_deposit_amount DECIMAL(12,2),
    first_deposit_at TIMESTAMP,
    days_to_first_deposit INTEGER,
    
    -- 最大单笔
    max_deposit_amount DECIMAL(12,2),
    
    -- 出金率
    withdrawal_rate DECIMAL(5,2) DEFAULT 0, -- 百分比
    
    -- VIP状态
    is_vip BOOLEAN DEFAULT FALSE,
    vip_since TIMESTAMP,
    
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_customer_id (customer_id),
    INDEX idx_employee_id (employee_id),
    INDEX idx_net_deposit (net_deposit)
);
```

#### deposits (入金记录表)

```sql
CREATE TABLE deposits (
    id BIGSERIAL PRIMARY KEY,
    deposit_code VARCHAR(50) UNIQUE NOT NULL, -- DEP_yyyymmdd_xxx
    
    customer_id BIGINT NOT NULL REFERENCES customers(id),
    employee_id BIGINT NOT NULL REFERENCES employees(id),
    
    amount DECIMAL(12,2) NOT NULL,
    currency VARCHAR(10) NOT NULL DEFAULT 'USD',
    
    deposit_type VARCHAR(50) NOT NULL, -- 首金/复入金/大额入金
    platform VARCHAR(100),
    
    status VARCHAR(20) NOT NULL DEFAULT 'pending', -- pending/confirmed/failed
    
    notes TEXT,
    
    deposited_at TIMESTAMP NOT NULL,
    confirmed_at TIMESTAMP,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_customer_id (customer_id),
    INDEX idx_employee_id (employee_id),
    INDEX idx_deposited_at (deposited_at),
    INDEX idx_deposit_type (deposit_type)
);
```

#### withdrawals (出金记录表)

```sql
CREATE TABLE withdrawals (
    id BIGSERIAL PRIMARY KEY,
    withdrawal_code VARCHAR(50) UNIQUE NOT NULL, -- WTH_yyyymmdd_xxx
    
    customer_id BIGINT NOT NULL REFERENCES customers(id),
    employee_id BIGINT NOT NULL REFERENCES employees(id),
    
    amount DECIMAL(12,2) NOT NULL,
    currency VARCHAR(10) NOT NULL DEFAULT 'USD',
    
    reason VARCHAR(100), -- 盈利提现/恐慌离场/资金需求/其他
    risk_level VARCHAR(20), -- 低/中/高
    
    retention_action TEXT, -- 挽留措施
    retention_success BOOLEAN,
    
    status VARCHAR(20) NOT NULL DEFAULT 'pending',
    
    requested_at TIMESTAMP NOT NULL,
    processed_at TIMESTAMP,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_customer_id (customer_id),
    INDEX idx_risk_level (risk_level),
    INDEX idx_requested_at (requested_at)
);
```

### 2.3 沟通记录表

#### conversations (聊天记录表)

```sql
CREATE TABLE conversations (
    id BIGSERIAL PRIMARY KEY,
    
    customer_id BIGINT NOT NULL REFERENCES customers(id),
    employee_id BIGINT NOT NULL REFERENCES employees(id),
    
    message_type VARCHAR(20) NOT NULL, -- text/image/voice/video
    direction VARCHAR(10) NOT NULL, -- inbound/outbound
    
    content TEXT,
    media_url VARCHAR(500),
    
    -- 智能分析
    sentiment VARCHAR(20), -- positive/neutral/negative
    keywords JSONB,
    intention_signals JSONB, -- 识别到的意向信号
    risk_keywords JSONB, -- 风险关键词
    
    -- 话术使用
    script_used_id BIGINT REFERENCES scripts(id),
    is_反问 BOOLEAN DEFAULT FALSE,
    
    -- 质量评分
    quality_score INTEGER, -- 1-10
    
    platform VARCHAR(50), -- wechat/whatsapp/telegram
    
    sent_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_customer_id (customer_id),
    INDEX idx_employee_id (employee_id),
    INDEX idx_sent_at (sent_at),
    INDEX idx_sentiment (sentiment)
);
```

#### conversation_events (对话事件表)

```sql
CREATE TABLE conversation_events (
    id BIGSERIAL PRIMARY KEY,
    
    conversation_id BIGINT REFERENCES conversations(id),
    customer_id BIGINT NOT NULL REFERENCES customers(id),
    employee_id BIGINT NOT NULL REFERENCES employees(id),
    
    event_type VARCHAR(50) NOT NULL,
    -- 反问/框架输出/粘度建立/推进动作/高质量对话/意向信号/风险信号
    
    event_data JSONB,
    
    impact_score INTEGER, -- 对客户的影响分数
    
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_customer_id (customer_id),
    INDEX idx_event_type (event_type),
    INDEX idx_created_at (created_at)
);
```

### 2.4 员工相关表

#### employees (员工表)

```sql
CREATE TABLE employees (
    id BIGSERIAL PRIMARY KEY,
    employee_code VARCHAR(50) UNIQUE NOT NULL, -- EMP_xxx
    
    -- 基本信息
    name VARCHAR(100) NOT NULL,
    avatar_url VARCHAR(500),
    email VARCHAR(200) UNIQUE NOT NULL,
    phone VARCHAR(50),
    
    -- 账号信息
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    
    -- 角色权限
    role VARCHAR(50) NOT NULL, -- admin/manager/employee/trainer
    department VARCHAR(100), -- ToFu/MoFu/BoFu/VIP/培训
    
    -- 员工等级
    level VARCHAR(50) NOT NULL DEFAULT '新人',
    -- 新人/组员/A级执行者/精英/高手/主管
    
    -- 状态
    status VARCHAR(20) NOT NULL DEFAULT 'active', -- active/inactive/suspended
    
    -- 绩效数据（冗余字段，用于快速查询）
    total_customers INTEGER DEFAULT 0,
    active_customers INTEGER DEFAULT 0,
    total_net_deposit DECIMAL(15,2) DEFAULT 0,
    
    -- 时间戳
    hired_at DATE,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    last_login_at TIMESTAMP,
    
    INDEX idx_employee_code (employee_code),
    INDEX idx_role (role),
    INDEX idx_level (level)
);
```

#### employee_kpis (员工KPI表)

```sql
CREATE TABLE employee_kpis (
    id BIGSERIAL PRIMARY KEY,
    employee_id BIGINT NOT NULL REFERENCES employees(id),
    
    date DATE NOT NULL,
    
    -- ToFu KPIs
    tofu_contacts INTEGER DEFAULT 0, -- 接粉数
    tofu_retained INTEGER DEFAULT 0, -- 留群数
    tofu_retention_rate DECIMAL(5,2), -- 留群率
    
    -- MoFu KPIs
    mofu_quality_conversations INTEGER DEFAULT 0,
    mofu_反问_count INTEGER DEFAULT 0,
    mofu_accounts_opened INTEGER DEFAULT 0,
    
    -- BoFu KPIs
    bofu_deposits_count INTEGER DEFAULT 0,
    bofu_deposit_amount DECIMAL(12,2) DEFAULT 0,
    bofu_withdrawal_amount DECIMAL(12,2) DEFAULT 0,
    bofu_net_deposit DECIMAL(12,2) DEFAULT 0,
    bofu_withdrawal_rate DECIMAL(5,2),
    
    -- 综合评分
    overall_score DECIMAL(5,2),
    
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE(employee_id, date),
    INDEX idx_employee_date (employee_id, date),
    INDEX idx_date (date)
);
```

### 2.5 内容管理表

#### scripts (话术库表)

```sql
CREATE TABLE scripts (
    id BIGSERIAL PRIMARY KEY,
    script_code VARCHAR(50) UNIQUE NOT NULL,
    
    category VARCHAR(100) NOT NULL, -- 12大模型/四大链路/场景话术等
    subcategory VARCHAR(100),
    
    scenario VARCHAR(200), -- 适用场景
    level VARCHAR(20), -- 初级/中级/高级
    
    content_cn TEXT NOT NULL,
    content_en TEXT,
    
    purpose TEXT, -- 话术目的
    
    follow_up JSONB, -- 后续话术推荐
    
    tags JSONB,
    
    -- 效果统计
    usage_count INTEGER DEFAULT 0,
    success_count INTEGER DEFAULT 0,
    success_rate DECIMAL(5,2),
    avg_rating DECIMAL(3,2),
    
    is_active BOOLEAN DEFAULT TRUE,
    
    created_by BIGINT REFERENCES employees(id),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_category (category),
    INDEX idx_success_rate (success_rate)
);
```

#### materials (素材库表)

```sql
CREATE TABLE materials (
    id BIGSERIAL PRIMARY KEY,
    material_code VARCHAR(50) UNIQUE NOT NULL,
    
    type VARCHAR(20) NOT NULL, -- image/video/text/mixed
    category VARCHAR(100) NOT NULL, -- 生活自律/专业投资/心智价值观等
    subcategory VARCHAR(100),
    
    title VARCHAR(200),
    content TEXT,
    media_url VARCHAR(500),
    thumbnail_url VARCHAR(500),
    
    caption TEXT, -- 配文
    hashtags JSONB,
    
    purpose TEXT,
    suitable_stages JSONB, -- ["ToFu", "MoFu"]
    
    -- 效果统计
    views INTEGER DEFAULT 0,
    likes INTEGER DEFAULT 0,
    comments INTEGER DEFAULT 0,
    shares INTEGER DEFAULT 0,
    published_count INTEGER DEFAULT 0,
    
    tags JSONB,
    
    is_active BOOLEAN DEFAULT TRUE,
    
    created_by BIGINT REFERENCES employees(id),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_category (category),
    INDEX idx_type (type)
);
```

### 2.6 培训系统表

#### training_courses (培训课程表)

```sql
CREATE TABLE training_courses (
    id BIGSERIAL PRIMARY KEY,
    
    title VARCHAR(200) NOT NULL,
    description TEXT,
    
    course_type VARCHAR(50) NOT NULL, -- 7天上手/30天成才/90天中坚
    level VARCHAR(20), -- 新人/进阶/高级
    
    duration_days INTEGER,
    
    content JSONB, -- 课程内容结构
    
    is_required BOOLEAN DEFAULT FALSE,
    display_order INTEGER DEFAULT 0,
    
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
```

#### training_progress (培训进度表)

```sql
CREATE TABLE training_progress (
    id BIGSERIAL PRIMARY KEY,
    
    employee_id BIGINT NOT NULL REFERENCES employees(id),
    course_id BIGINT NOT NULL REFERENCES training_courses(id),
    
    status VARCHAR(20) NOT NULL DEFAULT 'not_started',
    -- not_started/in_progress/completed/failed
    
    progress_percentage INTEGER DEFAULT 0,
    
    score DECIMAL(5,2), -- 考试分数
    
    started_at TIMESTAMP,
    completed_at TIMESTAMP,
    
    UNIQUE(employee_id, course_id),
    INDEX idx_employee_id (employee_id),
    INDEX idx_status (status)
);
```

### 2.7 系统配置表

#### system_settings (系统配置表)

```sql
CREATE TABLE system_settings (
    id BIGSERIAL PRIMARY KEY,
    
    key VARCHAR(100) UNIQUE NOT NULL,
    value TEXT,
    value_type VARCHAR(20), -- string/number/boolean/json
    
    category VARCHAR(100),
    description TEXT,
    
    is_public BOOLEAN DEFAULT FALSE, -- 是否可被前端访问
    
    updated_by BIGINT REFERENCES employees(id),
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
```

## 3. 视图 (Views)

### 3.1 客户全景视图

```sql
CREATE VIEW v_customer_overview AS
SELECT 
    c.id,
    c.customer_code,
    c.name,
    c.tier,
    c.current_stage,
    c.intention_score,
    c.engagement_score,
    
    -- ToFu数据
    t.source_channel,
    t.stayed_in_group,
    
    -- MoFu数据
    m.total_conversations,
    m.high_quality_conversations,
    m.account_opened,
    
    -- BoFu数据
    b.total_deposits,
    b.total_withdrawals,
    b.net_deposit,
    b.withdrawal_rate,
    b.is_vip,
    
    -- 负责员工
    e.name AS employee_name,
    e.employee_code,
    
    c.created_at,
    c.last_contact_at
FROM customers c
LEFT JOIN funnel_tofu t ON c.id = t.customer_id
LEFT JOIN funnel_mofu m ON c.id = m.customer_id
LEFT JOIN funnel_bofu b ON c.id = b.customer_id
LEFT JOIN employees e ON c.assigned_employee_id = e.id;
```

### 3.2 员工绩效视图

```sql
CREATE VIEW v_employee_performance AS
SELECT 
    e.id,
    e.employee_code,
    e.name,
    e.level,
    e.department,
    
    COUNT(DISTINCT c.id) AS total_customers,
    COUNT(DISTINCT CASE WHEN c.status = 'active' THEN c.id END) AS active_customers,
    
    SUM(b.net_deposit) AS total_net_deposit,
    AVG(b.withdrawal_rate) AS avg_withdrawal_rate,
    
    COUNT(DISTINCT CASE WHEN m.account_opened THEN c.id END) AS accounts_opened,
    COUNT(DISTINCT CASE WHEN b.first_deposit_at IS NOT NULL THEN c.id END) AS first_deposits,
    
    e.created_at AS hired_at
FROM employees e
LEFT JOIN customers c ON e.id = c.assigned_employee_id
LEFT JOIN funnel_mofu m ON c.id = m.customer_id
LEFT JOIN funnel_bofu b ON c.id = b.customer_id
GROUP BY e.id;
```

## 4. 索引策略

### 4.1 关键索引

```sql
-- 客户表复合索引
CREATE INDEX idx_customers_tier_stage ON customers(tier, current_stage);
CREATE INDEX idx_customers_employee_status ON customers(assigned_employee_id, status);

-- 对话记录时间范围查询
CREATE INDEX idx_conversations_customer_time ON conversations(customer_id, sent_at DESC);

-- 入金记录时间范围查询
CREATE INDEX idx_deposits_employee_time ON deposits(employee_id, deposited_at DESC);

-- KPI表日期范围查询
CREATE INDEX idx_employee_kpis_date_range ON employee_kpis(date DESC, employee_id);
```

## 5. 数据分区策略

### 5.1 按时间分区

```sql
-- 对话记录表按月分区
CREATE TABLE conversations (
    -- ... 字段定义
) PARTITION BY RANGE (sent_at);

CREATE TABLE conversations_2025_11 PARTITION OF conversations
    FOR VALUES FROM ('2025-11-01') TO ('2025-12-01');

CREATE TABLE conversations_2025_12 PARTITION OF conversations
    FOR VALUES FROM ('2025-12-01') TO ('2026-01-01');
```

## 6. 数据备份策略

- **全量备份**: 每天凌晨3点
- **增量备份**: 每6小时一次
- **备份保留**: 30天
- **异地备份**: 云存储（AWS S3 / 阿里云OSS）

---

**文档版本**: v1.0  
**创建日期**: 2025-11-30  
**状态**: ✅ 已完成
